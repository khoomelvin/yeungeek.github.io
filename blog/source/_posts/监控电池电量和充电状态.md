title: 监控电池电量和充电状态
date: 2014-10-31 14:16:52
tags:
- android
- battery
categories:
- android
description:

  监控电池电量和充电状态，可以应用在很多场景.更改后台更新频率，从而减少更新对电池使用时间的影响;锁屏的应用上，显示电量和充电状态等.
---
  本次应用是在锁屏上,显示电量,并且监控充电的状态(设备是否连接电源)  
  >基本思路:  
  > * 获取当前电量,注册电量变化的广播
  > * 监听充电状态,监听设备是否连接电源

  #充电状态
  在充电的情况下,[BatteryManager](http://developer.android.com/intl/zh-cn/reference/android/os/BatteryManager.html)会通过一个包含充电状态的持续`Intent`广播所有的电池详情和充电详情.  
可以通过注册一个`BroadcastReceiver`来显示具充电情况.  
``` java
IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED);
Intent batteryIntent = context.registerReceiver(null, filter);
```
如果设备在充电情况下,可以提取当前的充电状态和充电方式.  
``` java
    private int getCurrentBattery(final Intent intent) {
        int level = intent.getIntExtra(BatteryManager.EXTRA_LEVEL, -1);
        int scale = intent.getIntExtra(BatteryManager.EXTRA_SCALE, -1);
        int battery = (int) (level / (float) scale * 100);
        return battery;
    }

    private boolean isCharging(final Intent intent) {
        int status = intent.getIntExtra(BatteryManager.EXTRA_STATUS, -1);
        int chargePlug = intent.getIntExtra(BatteryManager.EXTRA_PLUGGED, -1);
        return status == BatteryManager.BATTERY_STATUS_CHARGING || 
	         status == BatteryManager.BATTERY_STATUS_FULL;
    }
```
那如何来监控设备是否在充电,也是通过`BroadcastReceiver`来监听.  
只要设备连接或断开电源，[BatteryManager](http://developer.android.com/intl/zh-cn/reference/android/os/BatteryManager.html)就会广播相应的操作.  
**动态注册:**
``` java
   private void registerPowerReceiver() {
        //ACTION_BATTERY_LOW ACTION_BATTERY_OKAY ACTION_POWER_CONNECTED ACTION_POWER_DISCONNECTED
        batteryRecevier = new BatteryRecevier();
        IntentFilter filter = new IntentFilter();
        filter.addAction(Intent.ACTION_POWER_CONNECTED);
        filter.addAction(Intent.ACTION_POWER_DISCONNECTED);
        registerReceiver(batteryRecevier, filter);
    }
```
**在配置文件中声明:**
``` xml
<receiver android:name=".BatteryRecevier">
  <intent-filter>
    <action android:name="android.intent.action.ACTION_POWER_CONNECTED"/>
    <action android:name="android.intent.action.ACTION_POWER_DISCONNECTED"/>
  </intent-filter>
</receiver>
```

  #电量变化
获取电量变化,上面也有提到,只要注册了 `Intent.ACTION_BATTERY_CHANGED`的`BroadcastReceiver`,可以通过下面代码获取到电量情况:
``` java
int level = intent.getIntExtra(BatteryManager.EXTRA_LEVEL, -1);
int scale = intent.getIntExtra(BatteryManager.EXTRA_SCALE, -1);
int battery = (int) (level / (float) scale * 100);
``` 

  #API相关
上面介绍了获取电量和充电的状态,使用了其他中一些[BatteryManager](http://developer.android.com/intl/zh-cn/reference/android/os/BatteryManager.html) api.  
如果要比较完整的使用,可以参考以下api  
 ##Extra声明 

EXTRA | 说明 |
----|------|
EXTRA_HEALTH | 电池健康情况  |
EXTRA_ICON_SMALL | 电量状况的图标  |
EXTRA_LEVEL | 电池电量  |
EXTRA_PLUGGED | 充电类型  |
EXTRA_PRESENT | 是否有电池  |
EXTRA_SCALE | 电池最大容量  |
EXTRA_STATUS | 电池状态  |
EXTRA_TECHNOLOGY | 电池制造技术(Li)  |
EXTRA_TEMPERATURE | 电池温度  |
EXTRA_VOLTAGE | 电池伏数  |

上述的都是[ACTION_BATTERY_CHANGED](http://developer.android.com/intl/zh-cn/reference/android/content/Intent.html#ACTION_BATTERY_CHANGED)提供的.
 ##常量声明
 ###EXTRA_HEALTH
常量 | 含义 |
----|------|
BATTERY_HEALTH_COLD | 电池冷却  |
BATTERY_HEALTH_DEAD | 电池没电  |
BATTERY_HEALTH_GOOD | 电池良好  |
BATTERY_HEALTH_OVERHEAT | 电池过热  |
BATTERY_HEALTH_OVER_VOLTAGE | 过电压  |
BATTERY_HEALTH_UNKNOWN | 未知原因  |
BATTERY_HEALTH_UNSPECIFIED_FAILURE | 未定义错误  |
 ###EXTRA_PLUGGED
常量 | 含义 |
----|------|
BATTERY_PLUGGED_AC | AC充电器  |
BATTERY_PLUGGED_USB | USB充电  |
BATTERY_PLUGGED_WIRELESS | 无线充电  |
 ###EXTRA_STATUS
常量 | 含义 |
----|------|
BATTERY_STATUS_CHARGING | 正在充电  |
BATTERY_STATUS_DISCHARGING | 放电中  |
BATTERY_STATUS_FULL | 电池满 |
BATTERY_STATUS_NOT_CHARGING | 未充电 |
BATTERY_STATUS_UNKNOWN | 未知状态  |

  #应用实例
  该应用实例只是演示了监控电池电量和充电状态.   
  [Battery Samples](https://github.com/yeungeek/android-common/tree/master/android/AndroidSamples/app/src/main/java/com/yeungeek/androidsamples/battery)
  #深入了解
